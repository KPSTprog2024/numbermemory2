<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>なんばーめもりー</title>
    <!-- Phaser.js の読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ローディング表示用 */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        #loading-text {
            font-size: 24px;
            margin-top: 20px;
            color: #2196F3;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(33, 150, 243, 0.3);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 音声コントロール */
        #sound-control {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #sound-icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <!-- ローディング表示 -->
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">よみこみちゅう...</div>
    </div>

    <!-- 音声コントロール -->
    <div id="sound-control">
        <svg id="sound-icon" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.8-1-3.3-2.5-4v8c1.5-.7 2.5-2.2 2.5-4z" fill="#2196F3"/>
        </svg>
    </div>

    <div id="game-container"></div>

    <script>
        // ゲームが読み込まれたらローディング表示を非表示にする
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loading = document.getElementById('loading');
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 500);
            }, 500);
        });

        // 音声コントロール
        let soundEnabled = true;
        const soundControl = document.getElementById('sound-control');
        const soundIcon = document.getElementById('sound-icon');

        soundControl.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            updateSoundIcon();
            // 音声のミュート状態を切り替える
            if (game) {
                game.sound.mute = !soundEnabled;
            }
        });

        function updateSoundIcon() {
            if (soundEnabled) {
                soundIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.8-1-3.3-2.5-4v8c1.5-.7 2.5-2.2 2.5-4z" fill="#2196F3"/>';
            } else {
                soundIcon.innerHTML = '<path d="M16.5 12c0-1.8-1-3.3-2.5-4v2.2l2.5 2.5c0-.2 0-.5 0-.7zm2.5 0c0 .9-.2 1.8-.5 2.6l1.5 1.5c.5-1.3.8-2.6.8-4.1 0-5.2-3.7-9.5-8.5-10.5v2.1c3.6.9 6.5 4.2 6.5 8.4zM4.3 3L3 4.3 7.7 9H3v6h4l5 5v-6.7l4.3 4.3c-.7.6-1.5 1-2.3 1.3v2.1c1.5-.4 2.8-1.1 3.9-2.1l2.1 2.1 1.3-1.3L4.3 3zM12 4l-1.1 1.1 1.1 1.1V4z" fill="#2196F3"/>';
            }
        }

        // 共通の定数やユーティリティ関数を定義
        const COLORS = {
            primary: 0x2196F3,
            primaryLight: 0x64B5F6,
            primaryDark: 0x1976D2,
            success: 0x4CAF50,
            successLight: 0x81C784,
            successDark: 0x388E3C,
            danger: 0xFF5722,
            dangerLight: 0xFF8A65,
            dangerDark: 0xE64A19,
            warning: 0xFFC107,
            warningLight: 0xFFD54F,
            warningDark: 0xFFA000,
            info: 0x2196F3,
            infoLight: 0x64B5F6,
            infoDark: 0x1976D2,
            selected: 0xFF9800,
            selectedLight: 0xFFB74D,
            selectedDark: 0xF57C00,
            gray: 0x9E9E9E,
            grayLight: 0xE0E0E0,
            grayDark: 0x616161,
            background: 0xF5F5F5
        };

        // 効果音
        const SOUNDS = {
            click: null,
            success: null,
            error: null,
            levelUp: null,
            countdown: null
        };

        // フォントサイズとボタンサイズの調整関数
        function calculateResponsiveSize(scene, baseSize) {
            const { width, height } = scene.scale;
            const minDimension = Math.min(width, height);
            return Math.max(Math.round(minDimension * baseSize), 16);
        }

        // カスタムボタン作成関数（改良版）
        function createCustomButton(scene, text, x, y, width, height, backgroundColor, hoverColor, onClick) {
            const buttonContainer = scene.add.container(x, y);
            
            // ボタン背景をGraphicsで描画
            const buttonBackground = scene.add.graphics();
            buttonBackground.fillStyle(backgroundColor, 1);
            buttonBackground.fillRoundedRect(-width / 2, -height / 2, width, height, height / 4);
            
            // 影を追加
            const shadow = scene.add.graphics();
            shadow.fillStyle(0x000000, 0.2);
            shadow.fillRoundedRect(-width / 2 + 4, -height / 2 + 4, width, height, height / 4);
            
            // テキストを追加
            const fontSize = calculateResponsiveSize(scene, 0.045);
            const buttonText = scene.add.text(0, 0, text, {
                fontSize: `${fontSize}px`,
                fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                fill: '#fff',
                align: 'center',
                stroke: '#000',
                strokeThickness: 2
            }).setOrigin(0.5, 0.5);
            
            buttonContainer.add([shadow, buttonBackground, buttonText]);
            
            // インタラクティブ設定
            buttonContainer.setSize(width, height);
            buttonContainer.setInteractive({ useHandCursor: true });
            
            // デフォルトの色を保持
            buttonContainer.defaultColor = backgroundColor;
            buttonContainer.hoverColor = hoverColor;
            buttonContainer.selected = false;
            
            // ホバー時の処理
            buttonContainer.on('pointerover', () => {
                if (buttonContainer.selected) {
                    buttonBackground.clear();
                    buttonBackground.fillStyle(COLORS.selectedLight, 1);
                    buttonBackground.fillRoundedRect(-width / 2, -height / 2, width, height, height / 4);
                } else {
                    buttonBackground.clear();
                    buttonBackground.fillStyle(buttonContainer.hoverColor, 1);
                    buttonBackground.fillRoundedRect(-width / 2, -height / 2, width, height, height / 4);
                }
            });
            
            buttonContainer.on('pointerout', () => {
                if (buttonContainer.selected) {
                    buttonBackground.clear();
                    buttonBackground.fillStyle(COLORS.selected, 1);
                    buttonBackground.fillRoundedRect(-width / 2, -height / 2, width, height, height / 4);
                } else {
                    buttonBackground.clear();
                    buttonBackground.fillStyle(buttonContainer.defaultColor, 1);
                    buttonBackground.fillRoundedRect(-width / 2, -height / 2, width, height, height / 4);
                }
            });
            
            // クリック時の処理
            buttonContainer.on('pointerdown', () => {
                // クリック効果音
                if (SOUNDS.click && soundEnabled) {
                    SOUNDS.click.play();
                }
                
                scene.tweens.add({
                    targets: buttonContainer,
                    scale: { from: 1, to: 0.95 },
                    yoyo: true,
                    duration: 100,
                    onComplete: onClick
                });
            });
            
            return buttonContainer;
        }

        // 進捗バーの作成関数
        function createProgressBar(scene, x, y, width, height, value, maxValue) {
            const progressContainer = scene.add.container(x, y);
            
            // 背景
            const background = scene.add.graphics();
            background.fillStyle(COLORS.grayLight, 1);
            background.fillRoundedRect(-width / 2, -height / 2, width, height, height / 2);
            
            // プログレスバー
            const progress = scene.add.graphics();
            const progressWidth = (value / maxValue) * width;
            progress.fillStyle(COLORS.success, 1);
            progress.fillRoundedRect(-width / 2, -height / 2, progressWidth, height, height / 2);
            
            progressContainer.add([background, progress]);
            
            // 更新メソッド
            progressContainer.updateValue = (newValue) => {
                const newWidth = (newValue / maxValue) * width;
                progress.clear();
                progress.fillStyle(COLORS.success, 1);
                progress.fillRoundedRect(-width / 2, -height / 2, newWidth, height, height / 2);
            };
            
            return progressContainer;
        }

        // 星評価の作成関数
        function createStarRating(scene, x, y, rating, maxRating = 3, size = 50, spacing = 10) {
            const starContainer = scene.add.container(x, y);
            const totalWidth = (size * maxRating) + (spacing * (maxRating - 1));
            const startX = -totalWidth / 2 + size / 2;
            
            for (let i = 0; i < maxRating; i++) {
                const starX = startX + (size + spacing) * i;
                const filled = i < rating;
                
                const star = scene.add.graphics();
                if (filled) {
                    star.fillStyle(COLORS.warning, 1);
                } else {
                    star.fillStyle(COLORS.grayLight, 1);
                }
                
                // 星の形を描画
                drawStar(star, 0, 0, 5, size / 2, size / 4);
                star.x = starX;
                
                // 星が獲得されたときのアニメーション
                if (filled) {
                    scene.tweens.add({
                        targets: star,
                        scale: { from: 0, to: 1 },
                        duration: 300,
                        delay: i * 200,
                        ease: 'Back.out'
                    });
                }
                
                starContainer.add(star);
            }
            
            return starContainer;
        }

        // 星の形を描画する関数
        function drawStar(graphics, x, y, points, outerRadius, innerRadius) {
            const angle = Math.PI * 2 / points;
            
            graphics.beginPath();
            for (let i = 0; i < points * 2; i++) {
                const radius = i % 2 === 0 ? outerRadius : innerRadius;
                const currentAngle = i * angle / 2 - Math.PI / 2;
                const xPos = x + Math.cos(currentAngle) * radius;
                const yPos = y + Math.sin(currentAngle) * radius;
                
                if (i === 0) {
                    graphics.moveTo(xPos, yPos);
                } else {
                    graphics.lineTo(xPos, yPos);
                }
            }
            graphics.closePath();
            graphics.fillPath();
        }

        // パーティクルエフェクトの作成関数
        function createParticleEffect(scene, x, y, count = 20, colors = [0xFFD700, 0xFF9800, 0x4CAF50, 0x2196F3]) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 100 + Math.random() * 200;
                const distance = 50 + Math.random() * 100;
                const size = 5 + Math.random() * 15;
                const color = Phaser.Utils.Array.GetRandom(colors);
                
                const particle = scene.add.circle(x, y, size, color);
                
                scene.tweens.add({
                    targets: particle,
                    x: x + Math.cos(angle) * distance,
                    y: y + Math.sin(angle) * distance,
                    alpha: 0,
                    scale: { from: 1, to: 0 },
                    duration: 500 + Math.random() * 500,
                    ease: 'Cubic.out',
                    onComplete: () => particle.destroy()
                });
            }
        }

        // ヒント機能の作成関数
        function createHintButton(scene, x, y, remainingHints, onHintUsed) {
            const hintButton = scene.add.container(x, y);
            const size = 50;
            
            // 背景円
            const circle = scene.add.circle(0, 0, size / 2, COLORS.info);
            
            // テキスト
            const text = scene.add.text(0, 0, '?', {
                fontSize: '32px',
                fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                fill: '#fff',
                align: 'center'
            }).setOrigin(0.5, 0.5);
            
            // ヒント残数
            const countText = scene.add.text(size / 2 - 5, -size / 2 + 5, remainingHints, {
                fontSize: '16px',
                fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                fill: '#fff',
                backgroundColor: COLORS.danger,
                padding: { x: 5, y: 2 },
                borderRadius: 10
            }).setOrigin(0.5, 0.5);
            
            hintButton.add([circle, text, countText]);
            hintButton.setSize(size, size);
            hintButton.setInteractive({ useHandCursor: true });
            
            // クリック時の処理
            hintButton.on('pointerdown', () => {
                if (remainingHints > 0) {
                    remainingHints--;
                    countText.setText(remainingHints);
                    
                    // ヒントボタンを押した効果
                    scene.tweens.add({
                        targets: hintButton,
                        scale: { from: 1, to: 0.9 },
                        yoyo: true,
                        duration: 100,
                        onComplete: () => onHintUsed(remainingHints)
                    });
                } else {
                    // ヒントがない場合は揺らすアニメーション
                    scene.tweens.add({
                        targets: hintButton,
                        x: { from: x - 5, to: x + 5 },
                        yoyo: true,
                        repeat: 2,
                        duration: 50
                    });
                }
            });
            
            return hintButton;
        }

        // 一時停止ボタンの作成関数
        function createPauseButton(scene, x, y, onPause) {
            const pauseButton = scene.add.container(x, y);
            const size = 50;
            
            // 背景円
            const circle = scene.add.circle(0, 0, size / 2, COLORS.gray);
            
            // 一時停止アイコン
            const pauseIcon = scene.add.graphics();
            pauseIcon.fillStyle(0xFFFFFF, 1);
            pauseIcon.fillRect(-10, -12, 7, 24);
            pauseIcon.fillRect(3, -12, 7, 24);
            
            pauseButton.add([circle, pauseIcon]);
            pauseButton.setSize(size, size);
            pauseButton.setInteractive({ useHandCursor: true });
            
            // クリック時の処理
            pauseButton.on('pointerdown', () => {
                scene.tweens.add({
                    targets: pauseButton,
                    scale: { from: 1, to: 0.9 },
                    yoyo: true,
                    duration: 100,
                    onComplete: onPause
                });
            });
            
            return pauseButton;
        }

        // ベースとなるシーンクラス
        class BaseScene extends Phaser.Scene {
            constructor(key) {
                super({ key: key });
            }
            
            init(data) {
                this.displayTime = data.displayTime || 2000;
                this.level = data.level || 1;
                this.gridSize = data.gridSize || 3;
                this.gameMode = data.gameMode || 'number';
                this.remainingHints = data.remainingHints || 3; // ヒント回数
            }
            
            drawGrid() {
                const { width, height } = this.scale;
                const gridSize = this.gridSize;
                const gridLength = width < height ? width * 0.8 : height * 0.8;
                const startX = (width - gridLength) / 2;
                const startY = (height - gridLength) / 2;
                const cellSize = gridLength / gridSize;
                
                // グリッドの背景
                const gridBackground = this.add.rectangle(
                    startX + gridLength / 2,
                    startY + gridLength / 2,
                    gridLength + 10,
                    gridLength + 10,
                    0xFFFFFF
                ).setStrokeStyle(6, COLORS.primaryDark);
                
                // グリッドの線を描画
                const graphics = this.add.graphics();
                graphics.lineStyle(3, COLORS.primaryLight, 1);
                
                // 縦線と横線
                for (let i = 0; i <= gridSize; i++) {
                    // 縦線
                    graphics.moveTo(startX + i * cellSize, startY);
                    graphics.lineTo(startX + i * cellSize, startY + gridLength);
                    // 横線
                    graphics.moveTo(startX, startY + i * cellSize);
                    graphics.lineTo(startX + gridLength, startY + i * cellSize);
                }
                
                graphics.strokePath();
                
                return { startX, startY, cellSize, gridLength };
            }
            
            createParticleEffect(x, y, count, colors) {
                createParticleEffect(this, x, y, count, colors);
            }
            
            // 一時停止画面の作成
            createPauseScreen() {
                const { width, height } = this.scale;
                
                // 半透明の背景
                const overlay = this.add.rectangle(0, 0, width * 2, height * 2, 0x000000, 0.7)
                    .setOrigin(0)
                    .setDepth(100);
                
                // 一時停止メニューのコンテナ
                const pauseMenu = this.add.container(width / 2, height / 2)
                    .setDepth(101);
                
                // メニュー背景
                const menuBg = this.add.rectangle(0, 0, width * 0.8, height * 0.6, 0xFFFFFF, 0.95)
                    .setOrigin(0.5)
                    .setStrokeStyle(4, COLORS.primary);
                pauseMenu.add(menuBg);
                
                // タイトル
                const titleText = this.add.text(0, -height * 0.2, 'いちじていし', {
                    fontSize: `${calculateResponsiveSize(this, 0.06)}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#000',
                    align: 'center'
                }).setOrigin(0.5);
                pauseMenu.add(titleText);
                
                // 再開ボタン
                const resumeButton = createCustomButton(
                    this,
                    'つづける',
                    0,
                    -height * 0.05,
                    width * 0.6,
                    height * 0.1,
                    COLORS.success,
                    COLORS.successLight,
                    () => {
                        pauseMenu.destroy();
                        overlay.destroy();
                        this.scene.resume();
                    }
                );
                pauseMenu.add(resumeButton);
                
                // 最初からやり直すボタン
                const restartButton = createCustomButton(
                    this,
                    'やりなおす',
                    0,
                    height * 0.08,
                    width * 0.6,
                    height * 0.1,
                    COLORS.warning,
                    COLORS.warningLight,
                    () => {
                        pauseMenu.destroy();
                        overlay.destroy();
                        this.scene.start('CountdownScene', {
                            displayTime: this.displayTime,
                            level: this.level,
                            gridSize: this.gridSize,
                            gameMode: this.gameMode,
                            remainingHints: this.remainingHints
                        });
                    }
                );
                pauseMenu.add(restartButton);
                
                // 設定画面に戻るボタン
                const settingsButton = createCustomButton(
                    this,
                    'せっていにもどる',
                    0,
                    height * 0.21,
                    width * 0.6,
                    height * 0.1,
                    COLORS.danger,
                    COLORS.dangerLight,
                    () => {
                        pauseMenu.destroy();
                        overlay.destroy();
                        this.scene.start('SelectionScene');
                    }
                );
                pauseMenu.add(settingsButton);
                
                // アニメーション
                this.tweens.add({
                    targets: pauseMenu,
                    scale: { from: 0.8, to: 1 },
                    duration: 200,
                    ease: 'Back.out'
                });
                
                return { pauseMenu, overlay };
            }
        }

        // シーン1: SelectionScene
        class SelectionScene extends Phaser.Scene {
            constructor() {
                super({ key: 'SelectionScene' });
            }
            
            preload() {
                // 効果音の読み込み
                this.load.audio('click', 'https://cdn.jsdelivr.net/gh/photonstorm/phaser-examples@master/examples/assets/audio/SoundEffects/key.mp3');
                this.load.audio('success', 'https://cdn.jsdelivr.net/gh/photonstorm/phaser-examples@master/examples/assets/audio/SoundEffects/shot.mp3');
                this.load.audio('error', 'https://cdn.jsdelivr.net/gh/photonstorm/phaser-examples@master/examples/assets/audio/SoundEffects/squit.mp3');
                this.load.audio('levelUp', 'https://cdn.jsdelivr.net/gh/photonstorm/phaser-examples@master/examples/assets/audio/SoundEffects/alien_death1.mp3');
                this.load.audio('countdown', 'https://cdn.jsdelivr.net/gh/photonstorm/phaser-examples@master/examples/assets/audio/SoundEffects/numkey.mp3');
            }
            
            create() {
                const { width, height } = this.scale;
                
                // 効果音の設定
                if (!SOUNDS.click) {
                    SOUNDS.click = this.sound.add('click', { volume: 0.5 });
                    SOUNDS.success = this.sound.add('success', { volume: 0.5 });
                    SOUNDS.error = this.sound.add('error', { volume: 0.5 });
                    SOUNDS.levelUp = this.sound.add('levelUp', { volume: 0.5 });
                    SOUNDS.countdown = this.sound.add('countdown', { volume: 0.5 });
                }
                
                // 背景
                this.add.rectangle(width / 2, height / 2, width, height, 0xF0F8FF);
                
                // タイトル
                const titleFontSize = calculateResponsiveSize(this, 0.08);
                const titleText = this.add.text(width / 2, height * 0.1, 'なんばーめもりー', {
                    fontSize: `${titleFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: COLORS.primaryDark,
                    align: 'center',
                    stroke: '#fff',
                    strokeThickness: 6,
                    wordWrap: { width: width * 0.9 }
                }).setOrigin(0.5, 0.5);
                
                // タイトルアニメーション
                this.tweens.add({
                    targets: titleText,
                    scale: { from: 0.9, to: 1 },
                    yoyo: true,
                    repeat: -1,
                    duration: 1000,
                    ease: 'Sine.inOut'
                });
                
                // サブタイトル
                const subtitleFontSize = calculateResponsiveSize(this, 0.04);
                this.add.text(width / 2, height * 0.17, 'げーむせっていをえらんでね', {
                    fontSize: `${subtitleFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#000',
                    align: 'center',
                    wordWrap: { width: width * 0.9 }
                }).setOrigin(0.5, 0.5);
                
                // ボタン設定
                const buttonWidth = width * 0.25;
                const buttonHeight = height * 0.1;
                const buttonSpacing = width * 0.02;
                
                // 選択オプション
                const options = [
                    {
                        title: 'ひょうじじかんをえらんでね',
                        yPosition: 0.28,
                        items: [
                            { label: '0.5びょう', value: 500 },
                            { label: '1びょう', value: 1000 },
                            { label: '3びょう', value: 3000 }
                        ],
                        buttonsArray: 'timeButtons',
                        onSelect: (button, value) => {
                            this.selectedTime = value;
                            this.timeButtons.forEach(btn => {
                                btn.selected = false;
                                btn.emit('pointerout'); // 色を戻す
                            });
                            button.selected = true;
                            button.emit('pointerout'); // 色を更新
                            
                            // 選択エフェクト
                            createParticleEffect(this, button.x, button.y, 10, [COLORS.selected, COLORS.selectedLight]);
                            
                            this.events.emit('selectionChanged');
                        }
                    },
                    {
                        title: 'ぐりっどさいずをえらんでね',
                        yPosition: 0.48,
                        items: [
                            { label: '3x3', value: 3 },
                            { label: '4x4', value: 4 },
                            { label: '5x5', value: 5 }
                        ],                        buttonsArray: 'gridSizeButtons',
                        onSelect: (button, value) => {
                            this.selectedGridSize = value;
                            this.gridSizeButtons.forEach(btn => {
                                btn.selected = false;
                                btn.emit('pointerout');
                            });
                            button.selected = true;
                            button.emit('pointerout');
                            
                            // 選択エフェクト
                            createParticleEffect(this, button.x, button.y, 10, [COLORS.selected, COLORS.selectedLight]);
                            
                            this.events.emit('selectionChanged');
                        }
                    },
                    {
                        title: 'げーむもーどをえらんでね',
                        yPosition: 0.68,
                        items: [
                            { label: 'すうじもーど', value: 'number' },
                            { label: 'いろもーど', value: 'color' }
                        ],
                        buttonsArray: 'gameModeButtons',
                        onSelect: (button, value) => {
                            this.selectedGameMode = value;
                            this.gameModeButtons.forEach(btn => {
                                btn.selected = false;
                                btn.emit('pointerout');
                            });
                            button.selected = true;
                            button.emit('pointerout');
                            
                            // 選択エフェクト
                            createParticleEffect(this, button.x, button.y, 10, [COLORS.selected, COLORS.selectedLight]);
                            
                            this.events.emit('selectionChanged');
                        }
                    }
                ];
                
                // オプションごとにボタンを生成
                options.forEach(option => {
                    // セクションタイトル
                    const sectionFontSize = calculateResponsiveSize(this, 0.05);
                    this.add.text(width / 2, height * option.yPosition, option.title, {
                        fontSize: `${sectionFontSize}px`,
                        fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                        fill: '#000',
                        align: 'center',
                        wordWrap: { width: width * 0.9 }
                    }).setOrigin(0.5, 0.5);
                    
                    // ボタンを横に並べる
                    const totalWidth = option.items.length * buttonWidth + (option.items.length - 1) * buttonSpacing;
                    let startX = (width - totalWidth) / 2 + buttonWidth / 2;
                    const startY = height * (option.yPosition + 0.08);
                    
                    option.buttons = [];
                    
                    option.items.forEach((item, index) => {
                        const buttonX = startX + index * (buttonWidth + buttonSpacing);
                        const button = createCustomButton(
                            this,
                            item.label,
                            buttonX,
                            startY,
                            buttonWidth,
                            buttonHeight,
                            COLORS.primary,
                            COLORS.primaryLight,
                            () => option.onSelect(button, item.value)
                        );
                        
                        // ボタン登場アニメーション
                        this.tweens.add({
                            targets: button,
                            y: { from: startY - 20, to: startY },
                            alpha: { from: 0, to: 1 },
                            duration: 300,
                            delay: index * 100,
                            ease: 'Back.out'
                        });
                        
                        option.buttons.push(button);
                    });
                    
                    this[option.buttonsArray] = option.buttons;
                });
                
                // スタートボタン
                const startButtonWidth = width * 0.6;
                const startButtonHeight = height * 0.12;
                
                const startButton = createCustomButton(
                    this,
                    'スタート',
                    width / 2,
                    height * 0.85,
                    startButtonWidth,
                    startButtonHeight,
                    COLORS.success,
                    COLORS.successLight,
                    () => {
                        if (startButton.getData('enabled')) {
                            // スタートボタンエフェクト
                            createParticleEffect(this, width / 2, height * 0.85, 30, [COLORS.success, COLORS.successLight]);
                            
                            this.scene.start('CountdownScene', {
                                displayTime: this.selectedTime,
                                level: 1,
                                gridSize: this.selectedGridSize,
                                gameMode: this.selectedGameMode,
                                remainingHints: 3 // 初期ヒント回数
                            });
                        }
                    }
                );
                
                startButton.setAlpha(0.5); // 初期状態は無効
                startButton.setData('enabled', false);
                
                // スタートボタン登場アニメーション
                this.tweens.add({
                    targets: startButton,
                    y: { from: height * 0.9, to: height * 0.85 },
                    alpha: { from: 0, to: 0.5 },
                    duration: 500,
                    delay: 500,
                    ease: 'Back.out'
                });
                
                // スタートボタンのスタイル更新関数
                const updateStartButton = () => {
                    if (this.selectedTime && this.selectedGridSize && this.selectedGameMode) {
                        if (!startButton.getData('enabled')) {
                            this.tweens.add({
                                targets: startButton,
                                alpha: 1,
                                scale: { from: 1, to: 1.1 },
                                yoyo: true,
                                duration: 200
                            });
                        }
                        startButton.setData('enabled', true);
                    } else {
                        startButton.setAlpha(0.5);
                        startButton.setData('enabled', false);
                    }
                };
                
                // リスナーを追加して選択時にスタートボタンを更新
                this.events.on('selectionChanged', updateStartButton, this);
            }
        }

        // シーン2: CountdownScene
        class CountdownScene extends BaseScene {
            constructor() {
                super('CountdownScene');
            }
            
            create() {
                const { width, height } = this.scale;
                this.count = 3;
                
                // 背景
                this.add.rectangle(width / 2, height / 2, width, height, 0xF0F8FF);
                
                // レベル表示
                const levelFontSize = calculateResponsiveSize(this, 0.04);
                this.add.text(width * 0.05, height * 0.05, `れべる: ${this.level}`, {
                    fontSize: `${levelFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#000'
                }).setOrigin(0, 0);
                
                // カウントダウン用グリッド
                const gridInfo = this.drawGrid();
                
                // カウントダウン数字
                const countFontSize = calculateResponsiveSize(this, 0.2);
                this.countText = this.add.text(width / 2, height / 2, this.count, {
                    fontSize: `${countFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#FF0000',
                    align: 'center',
                    stroke: '#fff',
                    strokeThickness: 6
                }).setOrigin(0.5, 0.5);
                
                // カウントダウン数字にアニメーションを追加
                this.tweens.add({
                    targets: this.countText,
                    scale: { from: 0.5, to: 1.5 },
                    alpha: { from: 0, to: 1, duration: 300 },
                    yoyo: true,
                    repeat: 0,
                    duration: 700,
                    onComplete: () => {
                        if (SOUNDS.countdown && soundEnabled) {
                            SOUNDS.countdown.play();
                        }
                    }
                });
                
                this.timeEvent = this.time.addEvent({
                    delay: 1000,
                    callback: this.updateCountdown,
                    callbackScope: this,
                    loop: true
                });
            }
            
            updateCountdown() {
                this.count -= 1;
                if (this.count > 0) {
                    this.countText.setText(this.count);
                    
                    // カウントダウンアニメーション
                    this.tweens.add({
                        targets: this.countText,
                        scale: { from: 0.5, to: 1.5 },
                        alpha: { from: 0, to: 1, duration: 300 },
                        yoyo: true,
                        repeat: 0,
                        duration: 700,
                        onComplete: () => {
                            if (SOUNDS.countdown && soundEnabled) {
                                SOUNDS.countdown.play();
                            }
                        }
                    });
                } else {
                    this.timeEvent.remove(false);
                    // カウントダウン終了時にアニメーションを停止
                    this.tweens.killTweensOf(this.countText);
                    
                    // 「スタート！」テキスト表示
                    const startFontSize = calculateResponsiveSize(this, 0.1);
                    const startText = this.add.text(this.scale.width / 2, this.scale.height / 2, 'スタート！', {
                        fontSize: `${startFontSize}px`,
                        fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                        fill: '#4CAF50',
                        align: 'center',
                        stroke: '#fff',
                        strokeThickness: 6
                    }).setOrigin(0.5, 0.5).setAlpha(0);
                    
                    // スタートテキストアニメーション
                    this.tweens.add({
                        targets: startText,
                        scale: { from: 0.5, to: 1.5 },
                        alpha: { from: 0, to: 1 },
                        duration: 500,
                        onComplete: () => {
                            this.tweens.add({
                                targets: startText,
                                alpha: 0,
                                duration: 300,
                                onComplete: () => {
                                    this.scene.start('GameScene', {
                                        displayTime: this.displayTime,
                                        level: this.level,
                                        gridSize: this.gridSize,
                                        gameMode: this.gameMode,
                                        remainingHints: this.remainingHints
                                    });
                                }
                            });
                        }
                    });
                }
            }
        }

        // シーン3: GameScene
        class GameScene extends BaseScene {
            constructor() {
                super('GameScene');
            }
            
            init(data) {
                super.init(data);
                this.expectedNumber = 1;
                this.numbers = [];
                this.grid = [];
                this.wrongCells = [];
                this.totalTargets = 0;
                this.clickedTargets = 0;
                this.isHintActive = false;
                this.isPaused = false;
            }
            
            create() {
                const { width, height } = this.scale;
                
                // 背景
                this.add.rectangle(width / 2, height / 2, width, height, 0xF0F8FF);
                
                // レベル表示
                const levelFontSize = calculateResponsiveSize(this, 0.04);
                this.add.text(width * 0.05, height * 0.05, `れべる: ${this.level}`, {
                    fontSize: `${levelFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#000'
                }).setOrigin(0, 0);
                
                // 進捗バー
                const maxLevel = 10; // 仮の最大レベル
                this.progressBar = createProgressBar(
                    this,
                    width * 0.7,
                    height * 0.05,
                    width * 0.4,
                    height * 0.03,
                    this.level,
                    maxLevel
                );
                
                // レベルテキスト
                this.add.text(width * 0.7, height * 0.02, `レベル ${this.level}/${maxLevel}`, {
                    fontSize: `${calculateResponsiveSize(this, 0.03)}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#000'
                }).setOrigin(0.5, 0);
                
                // ヒントボタン
                this.hintButton = createHintButton(
                    this,
                    width * 0.9,
                    height * 0.1,
                    this.remainingHints,
                    (remainingHints) => this.showHint(remainingHints)
                );
                
                // 一時停止ボタン
                this.pauseButton = createPauseButton(
                    this,
                    width * 0.9,
                    height * 0.2,
                    () => this.pauseGame()
                );
                
                // グリッドの描画
                const gridInfo = this.drawGrid();
                
                // 数字または色の配置
                if (this.gameMode === 'number') {
                    this.placeNumbers(gridInfo);
                } else if (this.gameMode === 'color') {
                    this.placeColors(gridInfo);
                }
                
                // 一定時間後に表示を隠す
                this.hideTimer = this.time.delayedCall(this.displayTime, () => {
                    this.hideElements();
                }, [], this);
            }
            
            pauseGame() {
                if (this.isPaused) return;
                
                this.isPaused = true;
                this.scene.pause();
                
                // 一時停止画面を表示
                this.createPauseScreen();
            }
            
            showHint(remainingHints) {
                if (this.isHintActive) return;
                
                this.isHintActive = true;
                
                // ヒント使用時に全ての要素を一時的に表示
                this.grid.forEach(cell => {
                    if (cell.object && !cell.clicked) {
                        cell.object.setVisible(true);
                        
                        // ヒントとして表示されていることを示す効果
                        this.tweens.add({
                            targets: cell.object,
                            alpha: { from: 0.3, to: 0.8 },
                            yoyo: true,
                            duration: 500,
                            repeat: 1,
                            onComplete: () => {
                                if (!cell.clicked) {
                                    cell.object.setVisible(false);
                                }
                                this.isHintActive = false;
                            }
                        });
                    }
                });
            }
            
            placeNumbers(gridInfo) {
                const totalNumbers = this.level + 2;
                if (totalNumbers > this.gridSize * this.gridSize) {
                    alert('れべるがたかすぎます！ げーむをしゅうりょうします。');
                    this.scene.start('SelectionScene');
                    return;
                }
                
                // 1からtotalNumbersまでの数字を生成
                this.numbers = [];
                for (let i = 1; i <= totalNumbers; i++) {
                    this.numbers.push(i);
                }
                
                // 数字の配置場所をランダムに選択
                const availableIndices = Phaser.Utils.Array.NumberArray(0, this.grid.length - 1);
                Phaser.Utils.Array.Shuffle(availableIndices);
                
                this.numbers.forEach((num, index) => {
                    const gridIndex = availableIndices[index];
                    const cell = this.grid[gridIndex];
                    cell.number = num;
                    
                    // 数字のテキストオブジェクトを作成
                    const numberFontSize = calculateResponsiveSize(this, 0.06);
                    const numberText = this.add.text(cell.x, cell.y, num, {
                        fontSize: `${numberFontSize}px`,
                        fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                        fill: '#fff',
                        backgroundColor: Phaser.Display.Color.IntegerToColor(COLORS.danger).rgba,
                        padding: { x: 15, y: 15 },
                        borderRadius: 15,
                        align: 'center',
                        stroke: '#000',
                        strokeThickness: 2
                    }).setOrigin(0.5, 0.5).setVisible(true); // 初期は表示
                    
                    // 数字の登場アニメーション
                    this.tweens.add({
                        targets: numberText,
                        scale: { from: 0, to: 1 },
                        duration: 300,
                        delay: index * 100,
                        ease: 'Back.out'
                    });
                    
                    cell.object = numberText;
                });
            }
            
            placeColors(gridInfo) {
                const totalColors = this.level + 2;
                if (totalColors > this.gridSize * this.gridSize) {
                    alert('れべるがたかすぎます！ げーむをしゅうりょうします。');
                    this.scene.start('SelectionScene');
                    return;
                }
                
                // 色のリスト（コントラスト改善）
                const colors = [
                    0xff5733, // あか
                    0x33ff57, // みどり
                    0x3357ff, // あお
                    0xff33a8, // ピンク
                    0xfff933, // きいろ
                    0x33fff5, // みずいろ
                    0x8e44ad, // むらさき
                    0xe67e22, // オレンジ
                    0x2ecc71, // ライム
                    0x3498db  // あかるいあお
                ];
                
                // 色の選択
                const selectedColors = Phaser.Utils.Array.Shuffle(colors).slice(0, totalColors);
                
                // 色の配置場所をランダムに選択
                const availableIndices = Phaser.Utils.Array.NumberArray(0, this.grid.length - 1);
                Phaser.Utils.Array.Shuffle(availableIndices);
                
                selectedColors.forEach((color, index) => {
                    const gridIndex = availableIndices[index];
                    const cell = this.grid[gridIndex];
                    cell.color = color;
                    
                    // 色ブロックのオブジェクトを作成（初期は表示）
                    const colorBlock = this.add.rectangle(cell.x, cell.y, cell.width * 0.8, cell.height * 0.8, color, 1)
                        .setOrigin(0.5, 0.5)
                        .setStrokeStyle(3, 0x000000)
                        .setInteractive()
                        .setAlpha(1); // 初期は表示
                    
                    // 色ブロックの登場アニメーション
                    this.tweens.add({
                        targets: colorBlock,
                        scale: { from: 0, to: 1 },
                        duration: 300,
                        delay: index * 100,
                        ease: 'Back.out'
                    });
                    
                    cell.object = colorBlock;
                });
                
                this.totalTargets = selectedColors.length;
            }
            
            hideElements() {
                this.grid.forEach(cell => {
                    if (cell.object && !cell.clicked) {
                        // フェードアウトアニメーション
                        this.tweens.add({
                            targets: cell.object,
                            alpha: 0,
                            duration: 300,
                            onComplete: () => {
                                cell.object.setVisible(false);
                                cell.object.setAlpha(1); // アルファ値をリセット
                            }
                        });
                    }
                });
            }
            
            handleGridClick(row, col) {
                if (this.isHintActive || this.isPaused) return;
                
                const clickedCell = this.grid.find(cell => cell.row === row && cell.col === col);
                if (!clickedCell) return;
                
                if (this.gameMode === 'number') {
                    // 数字モード
                    if (clickedCell.number === null) {
                        this.wrongCells.push({ row, col });
                        if (SOUNDS.error && soundEnabled) {
                            SOUNDS.error.play();
                        }
                        this.scene.start('RetryScene', {
                            displayTime: this.displayTime,
                            level: this.level,
                            gridSize: this.gridSize,
                            gameMode: this.gameMode,
                            grid: this.grid,
                            wrongCells: this.wrongCells,
                            remainingHints: this.remainingHints
                        });
                        return;
                    }
                    
                    if (clickedCell.clicked) return;
                    
                    if (clickedCell.number === this.expectedNumber) {
                        clickedCell.clicked = true;
                        clickedCell.object.setStyle({ backgroundColor: Phaser.Display.Color.IntegerToColor(COLORS.success).rgba });
                        clickedCell.object.setVisible(true);
                        clickedCell.zone.disableInteractive();
                        
                        // 正解エフェクト
                        this.tweens.add({
                            targets: clickedCell.object,
                            scale: { from: 1, to: 1.2 },
                            yoyo: true,
                            duration: 200
                        });
                        
                        // パーティクルエフェクト
                        this.createParticleEffect(clickedCell.x, clickedCell.y, 10, [COLORS.success, COLORS.successLight]);
                        
                        if (SOUNDS.success && soundEnabled) {
                            SOUNDS.success.play();
                        }
                        
                        this.expectedNumber += 1;
                        
                        if (this.expectedNumber > this.numbers.length) {
                            this.time.delayedCall(500, () => {
                                if (SOUNDS.levelUp && soundEnabled) {
                                    SOUNDS.levelUp.play();
                                }
                                this.scene.start('ClearScene', {
                                    displayTime: this.displayTime,
                                    level: this.level,
                                    gridSize: this.gridSize,
                                    gameMode: this.gameMode,
                                    grid: this.grid,
                                    remainingHints: this.remainingHints
                                });
                            }, [], this);
                        }
                    } else {
                        this.wrongCells.push({ row, col });
                        if (SOUNDS.error && soundEnabled) {
                            SOUNDS.error.play();
                        }
                        
                        // 不正解エフェクト
                        if (clickedCell.object) {
                            this.tweens.add({
                                targets: clickedCell.object,
                                scale: { from: 1, to: 0.8 },
                                yoyo: true,
                                duration: 200,
                                onComplete: () => {
                                    this.scene.start('RetryScene', {
                                        displayTime: this.displayTime,
                                        level: this.level,
                                        gridSize: this.gridSize,
                                        gameMode: this.gameMode,
                                        grid: this.grid,
                                        wrongCells: this.wrongCells,
                                        remainingHints: this.remainingHints
                                    });
                                }
                            });
                        } else {
                            this.scene.start('RetryScene', {
                                displayTime: this.displayTime,
                                level: this.level,
                                gridSize: this.gridSize,
                                gameMode: this.gameMode,
                                grid: this.grid,
                                wrongCells: this.wrongCells,
                                remainingHints: this.remainingHints
                            });
                        }
                    }
                } else if (this.gameMode === 'color') {
                    // 色モード
                    if (clickedCell.color === null) {
                        this.wrongCells.push({ row, col });
                        if (SOUNDS.error && soundEnabled) {
                            SOUNDS.error.play();
                        }
                        this.scene.start('RetryScene', {
                            displayTime: this.displayTime,
                            level: this.level,
                            gridSize: this.gridSize,
                            gameMode: this.gameMode,
                            grid: this.grid,
                            wrongCells: this.wrongCells,
                            remainingHints: this.remainingHints
                        });
                        return;
                    }
                    
                    if (clickedCell.clicked) return;
                    
                    // 色モードではタッチが正しい場合に色ブロックを表示
                    clickedCell.clicked = true;
                    clickedCell.object.setVisible(true); // 表示
                    clickedCell.zone.disableInteractive();
                    
                    // 正解エフェクト
                    this.tweens.add({
                        targets: clickedCell.object,
                        scale: { from: 1, to: 1.2 },
                        yoyo: true,
                        duration: 200
                    });
                    
                    // パーティクルエフェクト
                    this.createParticleEffect(clickedCell.x, clickedCell.y, 10, [clickedCell.color]);
                    
                    if (SOUNDS.success && soundEnabled) {
                        SOUNDS.success.play();
                    }
                    
                    this.clickedTargets += 1;
                    
                    if (this.clickedTargets >= this.totalTargets) {
                        this.time.delayedCall(500, () => {
                            if (SOUNDS.levelUp && soundEnabled) {
                                SOUNDS.levelUp.play();
                            }
                            this.scene.start('ClearScene', {
                                displayTime: this.displayTime,
                                level: this.level,
                                gridSize: this.gridSize,
                                gameMode: this.gameMode,
                                grid: this.grid,
                                remainingHints: this.remainingHints
                            });
                        }, [], this);
                    }
                }
            }
            
            drawGrid() {
                const gridInfo = super.drawGrid();
                const { width, height } = this.scale;
                const gridSize = this.gridSize;
                const { startX, startY, cellSize, gridLength } = gridInfo;
                
                // グリッドセルのクリックエリアを設定
                for (let row = 0; row < gridSize; row++) {
                    for (let col = 0; col < gridSize; col++) {
                        const x = startX + col * cellSize + cellSize / 2;
                        const y = startY + row * cellSize + cellSize / 2;
                        
                        // グリッドセルの透明なボタンを作成
                        const zone = this.add.zone(x, y, cellSize, cellSize)
                            .setRectangleDropZone(cellSize * 0.9, cellSize * 0.9)
                            .setInteractive({ useHandCursor: true });
                        
                        // ホバー時のハイライト
                        const highlight = this.add.rectangle(x, y, cellSize * 0.9, cellSize * 0.9, 0xFFFFFF, 0.3)
                            .setStrokeStyle(2, COLORS.primary)
                            .setVisible(false);
                        
                        zone.on('pointerover', () => {
                            highlight.setVisible(true);
                        });
                        
                        zone.on('pointerout', () => {
                            highlight.setVisible(false);
                        });
                        
                        zone.on('pointerdown', () => {
                            this.handleGridClick(row, col);
                        });
                        
                        // グリッドセルの情報を保存
                        this.grid.push({
                            row: row,
                            col: col,
                            x: x,
                            y: y,
                            width: cellSize,
                            height: cellSize,
                            number: null, // 後で数字を割り当て
                            color: null,  // 後で色を割り当て
                            object: null, // テキストまたは色ブロックのオブジェクト
                            zone: zone,
                            highlight: highlight,
                            clicked: false
                        });
                    }
                }
                
                return gridInfo;
            }
        }

        // シーン4: ClearScene
        class ClearScene extends BaseScene {
            constructor() {
                super('ClearScene');
            }
            
            init(data) {
                super.init(data);
                this.grid = data.grid; // グリッドデータを受け取る
                this.messages = [
                    'すごい！',
                    'よくできた！',
                    'ナイス！',
                    'かんせい！',
                    'がんばったね！',
                    'きらきら！',
                    'ピカピカ！',
                    'スマート！',
                    'トップだ！',
                    'ファンタスティック！'
                ];
            }
            
            create() {
                const { width, height } = this.scale;
                
                // 背景
                this.add.rectangle(width / 2, height / 2, width, height, 0xF0F8FF);
                
                // グリッドの描画
                const gridInfo = this.drawGrid();
                
                // 正しい数字または色を全て表示
                this.grid.forEach(cell => {
                    if (this.gameMode === 'number' && cell.number !== null) {
                        const numberFontSize = calculateResponsiveSize(this, 0.06);
                        const numberText = this.add.text(cell.x, cell.y, cell.number, {
                            fontSize: `${numberFontSize}px`,
                            fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                            fill: '#fff',
                            backgroundColor: Phaser.Display.Color.IntegerToColor(COLORS.success).rgba,
                            padding: { x: 15, y: 15 },
                            borderRadius: 15,
                            align: 'center',
                            stroke: '#000',
                            strokeThickness: 2
                        }).setOrigin(0.5, 0.5).setVisible(true);
                        
                        // 数字の登場アニメーション
                        this.tweens.add({
                            targets: numberText,
                            scale: { from: 0, to: 1 },
                            duration: 300,
                            delay: cell.number * 100,
                            ease: 'Back.out'
                        });
                    } else if (this.gameMode === 'color' && cell.color !== null) {
                        const colorBlock = this.add.rectangle(cell.x, cell.y, cell.width * 0.8, cell.height * 0.8, cell.color, 1)
                            .setOrigin(0.5, 0.5)
                            .setStrokeStyle(3, 0x000000)
                            .setAlpha(1);
                        
                        // 色ブロックの登場アニメーション
                        this.tweens.add({
                            targets: colorBlock,
                            scale: { from: 0, to: 1 },
                            duration: 300,
                            delay: 100,
                            ease: 'Back.out'
                        });
                    }
                });
                
                // クリアテキスト
                const clearFontSize = calculateResponsiveSize(this, 0.08);
                const clearText = this.add.text(width / 2, height * 0.2, 'クリア！', {
                    fontSize: `${clearFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: Phaser.Display.Color.IntegerToColor(COLORS.warning).rgba,
                    align: 'center',
                    stroke: '#fff',
                    strokeThickness: 6,
                    wordWrap: { width: width * 0.9 }
                }).setOrigin(0.5, 0.5);
                
                // クリアテキストアニメーション
                this.tweens.add({
                    targets: clearText,
                    scale: { from: 0.5, to: 1.2 },
                    duration: 500,
                    yoyo: true,
                    repeat: 1,
                    ease: 'Back.out'
                });
                
                // ランダムメッセージ
                const messageFontSize = calculateResponsiveSize(this, 0.06);
                const randomMessage = Phaser.Utils.Array.GetRandom(this.messages);
                const messageText = this.add.text(width / 2, height * 0.35, randomMessage, {
                    fontSize: `${messageFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#000',
                    align: 'center',
                    wordWrap: { width: width * 0.9 }
                }).setOrigin(0.5, 0.5);
                
                // メッセージテキストアニメーション
                this.tweens.add({
                    targets: messageText,
                    y: { from: height * 0.35 - 20, to: height * 0.35 },
                    alpha: { from: 0, to: 1 },
                    duration: 500,
                    delay: 300,
                    ease: 'Sine.out'
                });
                
                // 星評価の表示
                const rating = Math.min(3, Math.ceil(this.level / 3)); // レベルに応じた星評価
                const starRating = createStarRating(this, width / 2, height * 0.45, rating);
                
                // エフェクト（花火）
                for (let i = 0; i < 3; i++) {
                    this.time.delayedCall(i * 300, () => {
                        this.createParticleEffect(
                            Phaser.Math.Between(width * 0.3, width * 0.7),
                            Phaser.Math.Between(height * 0.2, height * 0.4),
                            30,
                            [COLORS.warning, COLORS.warningLight, COLORS.success, COLORS.successLight]
                        );
                    });
                }
                
                // ボタンのサイズと位置
                const buttonWidth = width * 0.4;
                const buttonHeight = height * 0.1;
                const buttonSpacing = width * 0.05;
                const buttonYPosition = height * 0.65;
                
                // 「もういちど」ボタン
                const retryButton = createCustomButton(
                    this,
                    'もういちど',
                    width / 2 - buttonWidth / 2 - buttonSpacing / 2,
                    buttonYPosition,
                    buttonWidth,
                    buttonHeight,
                    COLORS.info,
                    COLORS.infoLight,
                    () => {
                        this.scene.start('CountdownScene', {
                            displayTime: this.displayTime,
                            level: this.level,
                            gridSize: this.gridSize,
                            gameMode: this.gameMode,
                            remainingHints: this.remainingHints
                        });
                    }
                );
                
                // 「つぎのれべる」ボタン
                const nextLevelButton = createCustomButton(
                    this,
                    'つぎのれべる',
                    width / 2 + buttonWidth / 2 + buttonSpacing / 2,
                    buttonYPosition,
                    buttonWidth,
                    buttonHeight,
                    COLORS.success,
                    COLORS.successLight,
                    () => {
                        this.scene.start('CountdownScene', {
                            displayTime: this.displayTime,
                            level: this.level + 1,
                            gridSize: this.gridSize,
                            gameMode: this.gameMode,
                            remainingHints: this.remainingHints
                        });
                    }
                );
                
                // ボタンアニメーション
                this.tweens.add({
                    targets: [retryButton, nextLevelButton],
                    y: { from: buttonYPosition + 50, to: buttonYPosition },
                    alpha: { from: 0, to: 1 },
                    duration: 500,
                    delay: 600,
                    ease: 'Back.out'
                });
                
                // 「さいしょから」ボタン
                const homeButton = createCustomButton(
                    this,
                    'さいしょから',
                    width / 2,
                    buttonYPosition + buttonHeight + 20,
                    buttonWidth * 0.8,
                    buttonHeight * 0.8,
                    COLORS.gray,
                    COLORS.grayLight,
                    () => {
                        this.scene.start('SelectionScene');
                    }
                );
                
                // ホームボタンアニメーション
                this.tweens.add({
                    targets: homeButton,
                    y: { from: buttonYPosition + buttonHeight + 50, to: buttonYPosition + buttonHeight + 20 },
                    alpha: { from: 0, to: 1 },
                    duration: 500,
                    delay: 800,
                    ease: 'Back.out'
                });
            }
        }

        // シーン5: RetryScene
        class RetryScene extends BaseScene {
            constructor() {
                super('RetryScene');
            }
            
            init(data) {
                super.init(data);
                this.grid = data.grid;
                this.wrongCells = data.wrongCells;
            }
            
            create() {
                const { width, height } = this.scale;
                
                // 背景
                this.add.rectangle(width / 2, height / 2, width, height, 0xF0F8FF);
                
                // ゲームオーバーのテキスト
                const gameOverFontSize = calculateResponsiveSize(this, 0.08);
                const gameOverText = this.add.text(width / 2, height * 0.2, 'ゲームオーバー', {
                    fontSize: `${gameOverFontSize}px`,
                    fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                    fill: '#FF0000',
                    align: 'center',
                    stroke: '#fff',
                    strokeThickness: 4,
                    wordWrap: { width: width * 0.9 }
                }).setOrigin(0.5, 0.5);
                
                // ゲームオーバーテキストアニメーション
                this.tweens.add({
                    targets: gameOverText,
                    scale: { from: 1.5, to: 1 },
                    duration: 500,
                    ease: 'Bounce.out'
                });
                
                // グリッドの描画
                const gridInfo = this.drawGrid();
                
                // 正しい数字または色を全て表示
                this.grid.forEach(cell => {
                    if (this.gameMode === 'number' && cell.number !== null) {
                        const numberFontSize = calculateResponsiveSize(this, 0.06);
                        const numberText = this.add.text(cell.x, cell.y, cell.number, {
                            fontSize: `${numberFontSize}px`,
                            fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                            fill: '#fff',
                            backgroundColor: Phaser.Display.Color.IntegerToColor(COLORS.danger).rgba,
                            padding: { x: 15, y: 15 },
                            borderRadius: 15,
                            align: 'center',
                            stroke: '#000',
                            strokeThickness: 2
                        }).setOrigin(0.5, 0.5).setVisible(true); // 正しい数字を表示
                    } else if (this.gameMode === 'color' && cell.color !== null) {
                        const colorBlock = this.add.rectangle(cell.x, cell.y, cell.width * 0.8, cell.height * 0.8, cell.color, 1)
                            .setOrigin(0.5, 0.5)
                            .setStrokeStyle(3, 0x000000)
                            .setAlpha(1); // 正しい色ブロックを表示
                    }
                });
                
                // 間違ってクリックされたセルに「×」マークを表示
                this.wrongCells.forEach(wrongCell => {
                    const cell = this.grid.find(c => c.row === wrongCell.row && c.col === wrongCell.col);
                    if (cell) {
                        const xMarkFontSize = calculateResponsiveSize(this, 0.1);
                        const xMark = this.add.text(cell.x, cell.y, '×', {
                            fontSize: `${xMarkFontSize}px`,
                            fontFamily: 'Arial Rounded MT Bold, Arial, sans-serif',
                            fill: '#FF0000',
                            stroke: '#fff',
                            strokeThickness: 3,
                            align: 'center'
                        }).setOrigin(0.5, 0.5);
                        
                        // ×マークのアニメーション
                        this.tweens.add({
                            targets: xMark,
                            scale: { from: 2, to: 1 },
                            duration: 300,
                            ease: 'Back.out'
                        });
                    }
                });
                
                // 「もういちど」ボタン
                const retryButton = createCustomButton(
                    this,
                    'もういちど',
                    width / 2,
                    height * 0.65,
                    width * 0.6,
                    height * 0.12,
                    COLORS.warning,
                    COLORS.warningLight,
                    () => {
                        this.scene.start('CountdownScene', {
                            displayTime: this.displayTime,
                            level: this.level,
                            gridSize: this.gridSize,
                            gameMode: this.gameMode,
                            remainingHints: this.remainingHints
                        });
                    }
                );
                
                // 「さいしょから」ボタン
                const restartButton = createCustomButton(
                    this,
                    'さいしょから',
                    width / 2,
                    height * 0.8,
                    width * 0.6,
                    height * 0.12,
                    COLORS.info,
                    COLORS.infoLight,
                    () => {
                        this.scene.start('SelectionScene');
                    }
                );
                
                // ボタンアニメーション
                this.tweens.add({
                    targets: [retryButton, restartButton],
                    scale: { from: 0.8, to: 1 },
                    alpha: { from: 0, to: 1 },
                    duration: 500,
                    delay: 500,
                    ease: 'Back.out'
                });
            }
        }

        // Phaserの設定
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: '#f0f8ff',
            scene: [SelectionScene, CountdownScene, GameScene, ClearScene, RetryScene],
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: window.innerWidth,
                height: window.innerHeight
            },
            // 解像度をデバイスのピクセル比に合わせる
            resolution: window.devicePixelRatio,
            // モバイルでのタッチ操作の最適化
            input: {
                activePointers: 1,
                touch: { capture: true }
            }
        };

        // ゲームインスタンスの作成
        const game = new Phaser.Game(config);

        // ウィンドウリサイズ時の対応
        window.addEventListener('resize', () => {
            game.scale.resize(window.innerWidth, window.innerHeight);
        });

        // iOS Safariでのスクロール防止
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // iOS Safariでのダブルタップズーム防止
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            const lastTouch = this.lastTouch || now + 1;
            const delta = now - lastTouch;
            if (delta < 500 && delta > 0) {
                e.preventDefault();
            }
            this.lastTouch = now;
        }, { passive: false });
    </script>
</body>
</html>                
