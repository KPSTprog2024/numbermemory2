<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>„Å™„Çì„Å∞„Éº„ÇÅ„ÇÇ„Çä„Éº ‚Äì Refactored</title>

<!-- ‚úÖ „É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„Åø -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script>

<style>
/* --- ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ --- */
html,body{margin:0;padding:0;background:#f0f8ff;font-family:'Arial Rounded MT Bold',Arial,sans-serif;overflow:hidden;-webkit-user-select:none;user-select:none}
#game-container{width:100vw;height:100vh;display:flex;justify-content:center;align-items:center}

#loading{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#f0f8ff;z-index:9999;transition:opacity .5s}
.spinner{width:50px;height:50px;border:5px solid rgba(33,150,243,.3);border-radius:50%;border-top-color:#2196F3;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

#sound-control{position:fixed;top:10px;right:10px;width:40px;height:40px;background:rgba(255,255,255,.7);border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,.2)}
#sound-control svg{width:24px;height:24px}
</style>
</head>

<body>
<!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
<div id="loading">
  <div class="spinner"></div>
  <div id="loading-text">„Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜ...</div>
</div>

<!-- „Çµ„Ç¶„É≥„ÉâÂàáÊõø -->
<div id="sound-control">
  <svg viewBox="0 0 24 24" id="sound-icon">
    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.8-1-3.3-2.5-4v8c1.5-.7 2.5-2.2 2.5-4z" fill="#2196F3"/>
  </svg>
</div>

<div id="game-container"></div>

<script>
/* ------------------------------------------------------------------
   üåà 0.  ÂÖ±ÈÄöÂÆöÊï∞„Éª„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
------------------------------------------------------------------ */
const COLORS = {
  primary:      0x2196F3, primaryLight: 0x64B5F6, primaryDark: 0x1976D2,
  success:      0x4CAF50, successLight: 0x81C784, successDark: 0x388E3C,
  danger:       0xFF5722, dangerLight:  0xFF8A65, dangerDark:  0xE64A19,
  warning:      0xFFC107, warningLight: 0xFFD54F, warningDark: 0xFFA000,
  info:         0x2196F3, gray:         0x9E9E9E, grayLight:   0xE0E0E0
};
const SOUND_KEYS = ['click','success','error','levelUp','countdown'];
const GAME_MAX_LEVEL = 10;

const U = {
  responsive(scene, ratio){const m=Math.min(scene.scale.width,scene.scale.height);return Math.max(Math.round(m*ratio),16);},
  rng(n){return Phaser.Math.Between(0,n-1)},
  rgba(i){return Phaser.Display.Color.IntegerToColor(i).rgba}
};

/* ------------------------------------------------------------------
   üéõÔ∏è 1.  Ê±éÁî® UI „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
------------------------------------------------------------------ */
class UIButton extends Phaser.GameObjects.Container{
  constructor(scene,x,y,w,h,label,bg,hover,cb){
    super(scene,x,y); scene.add.existing(this);
    this.bgColor=bg; this.hoverColor=hover; this.selected=false;

    this.shadow = scene.add.graphics();
    this.shadow.fillStyle(0x000000,.2)
               .fillRoundedRect(-w/2+4,-h/2+4,w,h,h/4);

    this.rect = scene.add.graphics();
    this.drawRect(bg);

    const fs=U.responsive(scene,.045);
    this.text = scene.add.text(0,0,label,
      {fontSize:`${fs}px`,fontFamily:'Arial Rounded MT Bold,Arial',fill:'#fff',align:'center',stroke:'#000',strokeThickness:2}
    ).setOrigin(.5);

    this.add([this.shadow,this.rect,this.text]);
    this.setSize(w,h).setInteractive({useHandCursor:true});

    this.on('pointerover',()=>this.drawRect(this.selected?COLORS.warning: hover));
    this.on('pointerout', ()=>this.drawRect(this.selected?COLORS.warning:bg));
    this.on('pointerdown',()=>{
      if(scene.soundLoaded && scene.soundEnabled) scene.sfx.click.play();
      scene.tweens.add({targets:this,scale:{from:1,to:.95},yoyo:true,duration:100,onComplete:cb});
    });
  }
  drawRect(color){
    this.rect.clear().fillStyle(color,1)
              .fillRoundedRect(-this.width/2,-this.height/2,this.width,this.height,this.height/4);
  }
}

/* ÈÅ∏ÊäûËÇ¢„Ç∞„É´„Éº„ÉóÔºàÊéí‰ªñÈÅ∏ÊäûÔºâ */
class OptionSelector extends Phaser.GameObjects.Container{
  constructor(scene,x,y,width,height,items,cb){
    super(scene,x,y); scene.add.existing(this);
    const spacing=width*.05, btnW=(width-(items.length-1)*spacing)/items.length, btnH=height;

    this.buttons=items.map((it,i)=>{
      const bx= (btnW+spacing)*i - width/2 + btnW/2;
      const b=new UIButton(scene,bx,0,btnW,btnH,it.label,
          COLORS.primary,COLORS.primaryLight,()=>this.select(b,it.value,cb));
      b.setAlpha(0);                        // ÁôªÂ†¥„Ç¢„Éã„É°
      scene.tweens.add({targets:b,y:b.y+20,alpha:1,duration:300,delay:i*100,ease:'Back.out'});
      return b;
    });
    this.add(this.buttons);
  }
  select(btn,val,cb){
    this.buttons.forEach(b=>{b.selected=false;b.emit('pointerout');});
    btn.selected=true; btn.emit('pointerout');
    cb(val);
  }
}

/* ÈÄ≤Êçó„Éê„Éº */
class ProgressBar extends Phaser.GameObjects.Container{
  constructor(scene,x,y,w,h,max){
    super(scene,x,y); scene.add.existing(this); this.w=w; this.h=h; this.max=max;
    this.bg=scene.add.graphics().fillStyle(COLORS.grayLight,1)
      .fillRoundedRect(-w/2,-h/2,w,h,h/2);
    this.bar=scene.add.graphics();
    this.add([this.bg,this.bar]); this.update(1);
  }
  update(val){
    this.bar.clear().fillStyle(COLORS.success,1)
      .fillRoundedRect(-this.w/2,-this.h/2,(val/this.max)*this.w,this.h,this.h/2);
  }
}

/* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
function burst(scene,x,y,count=20,colors=[COLORS.warning,COLORS.success]){
  for(let i=0;i<count;i++){
    const dist=Phaser.Math.Between(50,150),ang=Math.random()*Math.PI*2;
    const p=scene.add.circle(x,y,Phaser.Math.Between(4,12), _.sample(colors));
    scene.tweens.add({targets:p,
      x:x+Math.cos(ang)*dist,y:y+Math.sin(ang)*dist,alpha:0,scale:0,duration:600,
      ease:'Cubic.out',onComplete:()=>p.destroy()});
  }
}

/* ------------------------------------------------------------------
   üß© 2.  „Éô„Éº„Çπ„Ç∑„Éº„É≥
------------------------------------------------------------------ */
class BaseScene extends Phaser.Scene{
  constructor(key){super({key});}
  init(d){Object.assign(this,{
    displayTime: d.displayTime||2000, level:d.level||1, gridSize:d.gridSize||3,
    gameMode:d.gameMode||'number', remainingHints:d.remainingHints||3
  });}
  drawGrid(showBg=false){
    const {width:w,height:h}=this.scale, g=this.gridSize, len=Math.min(w,h)*.8;
    const sx=(w-len)/2, sy=(h-len)/2, cs=len/g;
    if(showBg) this.add.rectangle(sx+len/2,sy+len/2,len+10,len+10,0xffffff).setStrokeStyle(6,COLORS.primaryDark);

    const gph=this.add.graphics().lineStyle(3,COLORS.primaryLight,1);
    for(let i=0;i<=g;i++){
      gph.moveTo(sx+i*cs,sy).lineTo(sx+i*cs,sy+len);
      gph.moveTo(sx,sy+i*cs).lineTo(sx+len,sy+i*cs);
    }gph.strokePath();
    return{sx,sy,cs,len};
  }
  /* ÂÖ±ÈÄö„Éò„ÉÉ„ÉÄÔºà„É¨„Éô„É´ & „Éê„ÉºÔºâ */
  header(){
    const {width:w}=this.scale;
    this.add.text(w*.05,20,`„Çå„Åπ„Çã: ${this.level}`,
      {fontSize:`${U.responsive(this,.04)}px`,fontFamily:'Arial Rounded MT Bold',fill:'#000'}).setOrigin(0,0);
    this.prog=new ProgressBar(this,w*.7,30,w*.4,20,GAME_MAX_LEVEL); this.prog.update(this.level);
  }
}

/* ------------------------------------------------------------------
   üéÆ 3.  ÂêÑ„Ç∑„Éº„É≥
------------------------------------------------------------------ */
class SelectionScene extends Phaser.Scene{
  constructor(){super('SelectionScene');}
  preload(){
    SOUND_KEYS.forEach(k=>this.load.audio(k,`https://cdn.jsdelivr.net/gh/photonstorm/phaser-examples@master/examples/assets/audio/SoundEffects/${{click:'key',success:'shot',error:'squit',levelUp:'alien_death1',countdown:'numkey'}[k]}.mp3`));
  }
  create(){
    const {width:w,height:h}=this.scale, labelFS=U.responsive(this,.05);
    /* „Çµ„Ç¶„É≥„ÉâÊ∫ñÂÇô */
    this.sfx={}; SOUND_KEYS.forEach(k=>this.sfx[k]=this.sound.add(k,{volume:.5}));
    this.soundLoaded=true; this.soundEnabled=true;
    /* ËÉåÊôØ */
    this.add.rectangle(w/2,h/2,w,h,0xf0f8ff);

    /* „Çø„Ç§„Éà„É´ */
    this.add.text(w/2,h*.1,'„Å™„Çì„Å∞„Éº„ÇÅ„ÇÇ„Çä„Éº',
      {fontSize:`${U.responsive(this,.08)}px`,fontFamily:'Arial Rounded MT Bold',fill:U.rgba(COLORS.primaryDark),stroke:'#fff',strokeThickness:6}).setOrigin(.5);
    this.add.text(w/2,h*.17,'„Åí„Éº„ÇÄ„Åõ„Å£„Å¶„ÅÑ„Çí„Åà„Çâ„Çì„Åß„Å≠',
      {fontSize:`${U.responsive(this,.04)}px`,fontFamily:'Arial Rounded MT Bold',fill:'#000'}).setOrigin(.5);

    /* ÈÅ∏ÊäûËÇ¢„Éá„Éº„Çø */
    const selections=[
      {y:.30,title:'„Å≤„Çá„ÅÜ„Åò„Åò„Åã„Çì',items:[{l:'0.5„Å≥„Çá„ÅÜ',v:500},{l:'1„Å≥„Çá„ÅÜ',v:1000},{l:'3„Å≥„Çá„ÅÜ',v:3000}],key:'displayTime'},
      {y:.50,title:'„Åê„Çä„Å£„Å©„Åï„ÅÑ„Åö',items:[{l:'3x3',v:3},{l:'4x4',v:4},{l:'5x5',v:5}],key:'gridSize'},
      {y:.70,title:'„Åí„Éº„ÇÄ„ÇÇ„Éº„Å©',items:[{l:'„Åô„ÅÜ„Åò',v:'number'},{l:'„ÅÑ„Çç',v:'color'}],key:'gameMode'}
    ];

    selections.forEach(sel=>{
      this.add.text(w/2,h*sel.y,`${sel.title}„Çí„Åà„Çâ„Çì„Åß„Å≠`,
        {fontSize:`${labelFS}px`,fontFamily:'Arial Rounded MT Bold',fill:'#000'}).setOrigin(.5);
      const group=new OptionSelector(this,w/2,h*(sel.y+.08),w*.7,h*.1,sel.items.map(i=>({label:i.l,value:i.v})),v=>{
        this[sel.key]=v;burst(this,w/2,h*.9,12,[COLORS.primary,COLORS.primaryLight]);toggleStart();
      });
    });

    /* „Çπ„Çø„Éº„Éà„Éú„Çø„É≥ */
    const startBtn=new UIButton(this,w/2,h*.9,w*.6,h*.12,'„Çπ„Çø„Éº„Éà',
        COLORS.success,COLORS.successLight,()=>this.scene.start('CountdownScene',{
          displayTime:this.displayTime,level:1,gridSize:this.gridSize,gameMode:this.gameMode,remainingHints:3}));
    startBtn.setAlpha(.5).setData('enabled',false);

    const toggleStart=()=>{
      const ok=this.displayTime&&this.gridSize&&this.gameMode;
      if(ok&&!startBtn.getData('enabled')){
        this.tweens.add({targets:startBtn,alpha:1,scale:{from:1,to:1.1},yoyo:true,duration:200});
        startBtn.setData('enabled',true);
      }else if(!ok){startBtn.setAlpha(.5);startBtn.setData('enabled',false);}
    };

    /* „Çµ„Ç¶„É≥„ÉâÂàáÊõø UI „Å®„ÅÆÈÄ£Âãï */
    const sndCtrl=document.getElementById('sound-control');
    sndCtrl.onclick=()=>{
      this.soundEnabled=!this.soundEnabled;
      this.sound.mute=!this.soundEnabled;
      document.getElementById('sound-icon').innerHTML=this.soundEnabled
       ?'<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.8-1-3.3-2.5-4v8c1.5-.7 2.5-2.2 2.5-4z" fill="#2196F3"/>'
       :'<path d="M16.5 12c0-1.8-1-3.3-2.5-4v2.2l2.5 2.5c0-.2 0-.5 0-.7zm2.5 0c0 .9-.2 1.8-.5 2.6l1.5 1.5c.5-1.3.8-2.6.8-4.1 0-5.2-3.7-9.5-8.5-10.5v2.1c3.6.9 6.5 4.2 6.5 8.4zM4.3 3L3 4.3 7.7 9H3v6h4l5 5v-6.7l4.3 4.3c-.7.6-1.5 1-2.3 1.3v2.1c1.5-.4 2.8-1.1 3.9-2.1l2.1 2.1 1.3-1.3L4.3 3zM12 4l-1.1 1.1 1.1 1.1V4z" fill="#2196F3"/>';
    };
  }
}

class CountdownScene extends BaseScene{
  constructor(){super('CountdownScene');}
  create(){
    const {width:w,height:h}=this.scale;this.add.rectangle(w/2,h/2,w,h,0xf0f8ff);
    this.header();this.count=3;
    const fs=U.responsive(this,.2);
    this.txt=this.add.text(w/2,h/2,this.count,{fontSize:`${fs}px`,fontFamily:'Arial Rounded MT Bold',fill:'#ff0000',stroke:'#fff',strokeThickness:6}).setOrigin(.5);
    const pulse=()=>this.tweens.add({targets:this.txt,scale:{from:.5,to:1.5},alpha:{from:0,to:1,duration:300},yoyo:true,duration:700});
    pulse();
    this.time.addEvent({delay:1000,loop:true,callback:()=>{
      this.count--;if(this.count>0){this.txt.setText(this.count);pulse();}
      else{
        this.txt.destroy();
        const go=this.add.text(w/2,h/2,'„Çπ„Çø„Éº„ÉàÔºÅ',{fontSize:`${U.responsive(this,.1)}px`,fontFamily:'Arial Rounded MT Bold',fill:U.rgba(COLORS.success),stroke:'#fff',strokeThickness:6}).setOrigin(.5);
        this.tweens.add({targets:go,scale:{from:.5,to:1.5},alpha:{from:0,to:1},duration:400,onComplete:()=>{
          this.scene.start('GameScene',this.data.settings);
        }});
      }
    }});
  }
}

class GameScene extends BaseScene{
  constructor(){super('GameScene');}
  init(d){super.init(d);Object.assign(this,{expect:1,numbers:[],grid:[],clicked:0,isHint:false,isPaused:false});}
  create(){
    const {width:w,height:h}=this.scale;this.add.rectangle(w/2,h/2,w,h,0xf0f8ff);this.header();
    /* „Éí„É≥„Éà„Éú„Çø„É≥ */
    new UIButton(this,w*.9,h*.1,60,60,'? ',COLORS.info,COLORS.infoLight,()=>this.showHint()).setScale(.9)
        .add(this.add.text(15,-18,this.remainingHints,{fontSize:'14px',fontFamily:'Arial Rounded MT Bold'}));
    /* ‰∏ÄÊôÇÂÅúÊ≠¢ */
    new UIButton(this,w*.9,h*.2,60,60,'‚Äñ',COLORS.gray,COLORS.grayLight,()=>this.pauseGame()).setScale(.9);

    /* „Ç∞„É™„ÉÉ„Éâ„Çª„É´„ÇØ„É™„ÉÉ„ÇØ„Çæ„Éº„É≥‰ΩúÊàê */
    const {sx,sy,cs}=this.drawGrid(true);
    for(let r=0;r<this.gridSize;r++)for(let c=0;c<this.gridSize;c++){
      const x=sx+c*cs+cs/2,y=sy+r*cs+cs/2,zone=this.add.zone(x,y,cs,cs)
        .setInteractive({useHandCursor:true})
        .on('pointerdown',()=>this.onClick(r,c));
      this.grid.push({r,c,x,y,zone,obj:null,number:null,color:null,clicked:false});
    }

    /* Ë¶ÅÁ¥†ÈÖçÁΩÆ */
    this.gameMode==='number'?this.placeNumbers():this.placeColors();
    /* Ë¶ö„Åà„ÇãÊôÇÈñìÁµåÈÅéÂæå„Å´Èö†„Åô */
    this.time.delayedCall(this.displayTime,()=>this.grid.filter(c=>!c.clicked&&c.obj).forEach(c=>this.tweens.add({targets:c.obj,alpha:0,duration:300,onComplete:()=>c.obj.setVisible(false)})));
  }
  placeNumbers(){
    const total=this.level+2;if(total>this.grid.length)return alert('„É¨„Éô„É´„Åå„Åü„Åã„Åô„Åé„Åæ„Åô'),this.scene.start('SelectionScene');
    const idxs=_.shuffle(_.range(this.grid.length)).slice(0,total);
    idxs.forEach((i,n)=>{
      const cell=this.grid[i];cell.number=n+1;
      const t=this.add.text(cell.x,cell.y,n+1,
        {fontSize:`${U.responsive(this,.06)}px`,fontFamily:'Arial Rounded MT Bold',fill:'#fff',
         backgroundColor:U.rgba(COLORS.danger),padding:{x:15,y:15},borderRadius:15,stroke:'#000',strokeThickness:2})
        .setOrigin(.5);cell.obj=t;
      this.tweens.add({targets:t,scale:{from:0,to:1},duration:300,delay:n*80,ease:'Back.out'});
    });
  }
  placeColors(){
    const total=this.level+2, palette=[0xff5733,0x33ff57,0x3357ff,0xff33a8,0xfff933,0x33fff5,0x8e44ad,0xe67e22,0x2ecc71,0x3498db];
    const idxs=_.shuffle(_.range(this.grid.length)).slice(0,total), colors=_.shuffle(palette).slice(0,total);
    idxs.forEach((i,n)=>{
      const cell=this.grid[i];cell.color=colors[n];
      const rect=this.add.rectangle(cell.x,cell.y,cs*.8,cs*.8,colors[n]).setStrokeStyle(3,0x000000);
      cell.obj=rect;
      this.tweens.add({targets:rect,scale:{from:0,to:1},duration:300,delay:n*80,ease:'Back.out'});
    });
    this.totalTargets=total;
  }
  onClick(r,c){
    if(this.isHint||this.isPaused) return;
    const cell=this.grid.find(v=>v.r===r&&v.c===c); if(!cell||cell.clicked) return;
    const correct = this.gameMode==='number' ? cell.number===this.expect : cell.color!==null;
    if(!correct){this.wrong(cell);return;}
    /* Ê≠£Ëß£Âá¶ÁêÜ */
    cell.clicked=true; cell.obj.setVisible(true);
    cell.zone.disableInteractive(); burst(this,cell.x,cell.y,10,[COLORS.success,COLORS.successLight]);
    if(this.soundEnabled) this.scene.get('SelectionScene').sfx.success.play();
    if(this.gameMode==='number'){
      cell.obj.setStyle({backgroundColor:U.rgba(COLORS.success)}); this.expect++;
      if(this.expect>this.level+2) return this.clear();
    }else{
      this.clicked++; if(this.clicked>=this.totalTargets) return this.clear();
    }
  }
  wrong(cell){
    burst(this,cell.x,cell.y,10,[COLORS.danger]);
    if(this.soundEnabled) this.scene.get('SelectionScene').sfx.error.play();
    this.scene.start('RetryScene',this.data.settings);
  }
  showHint(){
    if(this.remainingHints<=0||this.isHint)return;
    this.remainingHints--;this.isHint=true;
    this.grid.filter(c=>!c.clicked&&c.obj).forEach(c=>{
      c.obj.setVisible(true);this.tweens.add({targets:c.obj,alpha:{from:.3,to:.8},yoyo:true,duration:600,onComplete:()=>{
        if(!c.clicked)c.obj.setVisible(false);this.isHint=false;
      }});
    });
  }
  pauseGame(){
    if(this.isPaused)return;this.isPaused=true;this.scene.pause();
    const {width:w,height:h}=this.scale, overlay=this.add.rectangle(0,0,w*2,h*2,0x000000,.7).setOrigin(0).setDepth(100);
    const menu=this.add.container(w/2,h/2).setDepth(101);
    menu.add(this.add.rectangle(0,0,w*.8,h*.6,0xffffff,.95).setStrokeStyle(4,COLORS.primary));
    const mkBtn=(txt,dy,color,cb)=>new UIButton(this,0,dy,w*.6,h*.1,txt,color,color+0x111111,()=>{overlay.destroy();menu.destroy();cb();});
    const fs=U.responsive(this,.06); menu.add(this.add.text(0,-h*.22,'„ÅÑ„Å°„Åò„Å¶„ÅÑ„Åó',{fontSize:`${fs}px`,fontFamily:'Arial Rounded MT Bold',fill:'#000'}).setOrigin(.5));
    menu.add(mkBtn('„Å§„Å•„Åë„Çã', -h*.1, COLORS.success, ()=>{this.scene.resume();this.isPaused=false;}));
    menu.add(mkBtn('„ÇÑ„Çä„Å™„Åä„Åô',0,COLORS.warning, ()=>this.scene.start('CountdownScene',this.data.settings)));
    menu.add(mkBtn('„Åõ„Å£„Å¶„ÅÑ„Å´„ÇÇ„Å©„Çã', h*.1, COLORS.danger, ()=>this.scene.start('SelectionScene')));
    this.tweens.add({targets:menu,scale:{from:.8,to:1},duration:200,ease:'Back.out'});
  }
  clear(){this.scene.start('ClearScene',this.data.settings);}
}

class ClearScene extends BaseScene{
  constructor(){super('ClearScene');}
  create(){
    const {width:w,height:h}=this.scale;this.add.rectangle(w/2,h/2,w,h,0xf0f8ff);this.header();
    const fs=U.responsive(this,.08);
    this.add.text(w/2,h*.2,'„ÇØ„É™„Ç¢ÔºÅ',{fontSize:`${fs}px`,fontFamily:'Arial Rounded MT Bold',fill:U.rgba(COLORS.warning),stroke:'#fff',strokeThickness:6}).setOrigin(.5);
    const msg=['„Åô„Åî„ÅÑÔºÅ','„Çà„Åè„Åß„Åç„ÅüÔºÅ','„Éä„Ç§„ÇπÔºÅ','„Åã„Çì„Åõ„ÅÑÔºÅ'];this.add.text(w/2,h*.32,_.sample(msg),
      {fontSize:`${U.responsive(this,.06)}px`,fontFamily:'Arial Rounded MT Bold',fill:'#000'}).setOrigin(.5);
    /* ÊòüË©ï‰æ° */
    const stars=Math.min(3,Math.ceil(this.level/3)),size=40,spacing=10,totalW=stars*size+(stars-1)*spacing,startX=w/2-totalW/2;
    for(let i=0;i<stars;i++){
      const g=this.add.graphics({x:startX+i*(size+spacing)+size/2,y:h*.45});
      g.fillStyle(COLORS.warning,1);
      drawStar(g,0,0,5,size/2,size/4);
      this.tweens.add({targets:g,scale:{from:0,to:1},duration:300,delay:i*150,ease:'Back.out'});
    }
    burst(this,w/2,h*.25,30,[COLORS.warning,COLORS.success]);

    /* „Éú„Çø„É≥ */
    const y=h*.65,bw=w*.4,bh=h*.11,sp=w*.05;
    new UIButton(this,w/2-bw/2-sp/2,y,bw,bh,'„ÇÇ„ÅÜ„ÅÑ„Å°„Å©',COLORS.info,COLORS.infoLight,()=>this.scene.start('CountdownScene',this.data.settings));
    new UIButton(this,w/2+bw/2+sp/2,y,bw,bh,'„Å§„Åé„ÅÆ„Çå„Åπ„Çã',COLORS.success,COLORS.successLight,
      ()=>{this.data.settings.level++;this.scene.start('CountdownScene',this.data.settings);});
    new UIButton(this,w/2,y+bh+20,bw*.8,bh*.8,'„Åï„ÅÑ„Åó„Çá„Åã„Çâ',COLORS.gray,COLORS.grayLight,()=>this.scene.start('SelectionScene'));
  }
}

class RetryScene extends BaseScene{
  constructor(){super('RetryScene');}
  create(){
    const {width:w,height:h}=this.scale;this.add.rectangle(w/2,h/2,w,h,0xf0f8ff);
    this.add.text(w/2,h*.2,'„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº',{fontSize:`${U.responsive(this,.08)}px`,fontFamily:'Arial Rounded MT Bold',fill:'#ff0000',stroke:'#fff',strokeThickness:4}).setOrigin(.5);
    burst(this,w/2,h*.25,25,[COLORS.danger]);
    /* „Éú„Çø„É≥ */
    new UIButton(this,w/2,h*.65,w*.6,h*.12,'„ÇÇ„ÅÜ„ÅÑ„Å°„Å©',COLORS.warning,COLORS.warningLight,()=>this.scene.start('CountdownScene',this.data.settings));
    new UIButton(this,w/2,h*.8,w*.6,h*.12,'„Åï„ÅÑ„Åó„Çá„Åã„Çâ',COLORS.info,COLORS.infoLight,()=>this.scene.start('SelectionScene'));
  }
}

/* Êòü„ÅÆÊèèÁîª„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ÔºàÂÜçÂà©Áî®Ôºâ */
function drawStar(g,x,y,pts,outer,inner){
  const ang=Math.PI*2/pts;g.beginPath();
  for(let i=0;i<pts*2;i++){
    const r=i%2===0?outer:inner, a=i*ang/2-Math.PI/2;
    const px=x+Math.cos(a)*r,py=y+Math.sin(a)*r;
    i?g.lineTo(px,py):g.moveTo(px,py);
  }g.closePath();g.fillPath();
}

/* ------------------------------------------------------------------
   üöÄ 4.  Phaser „Ç≤„Éº„É†Ëµ∑Âãï
------------------------------------------------------------------ */
const cfg={
  type:Phaser.AUTO,parent:'game-container',width:window.innerWidth,height:window.innerHeight,
  backgroundColor:'#f0f8ff',scene:[SelectionScene,CountdownScene,GameScene,ClearScene,RetryScene],
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:window.innerWidth,height:window.innerHeight},
  input:{activePointers:1,touch:{capture:true}},resolution:window.devicePixelRatio
};
const game=new Phaser.Game(cfg);

/* „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫ */
window.addEventListener('load',()=>setTimeout(()=>{document.getElementById('loading').style.opacity='0';
setTimeout(()=>document.getElementById('loading').style.display='none',500);},500));
/* „É™„Çµ„Ç§„Ç∫ */
window.addEventListener('resize',()=>game.scale.resize(window.innerWidth,window.innerHeight));
/* iOS „Çπ„ÇØ„É≠„Éº„É´ & „ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÊäëÊ≠¢ */
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
document.addEventListener('touchend',function(e){const n=Date.now(),d=n-(this.lastTouch||n+1);if(d<500&&d>0)e.preventDefault();this.lastTouch=n;},{passive:false});
</script>
</body>
</html>
